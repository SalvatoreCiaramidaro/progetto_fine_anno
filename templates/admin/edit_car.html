{% extends 'base.html' %}

{% block search_bar %}{% endblock %}

{% block title %}Modifica Auto - Wiki Sport Cars{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Modifica Auto: {{ car.name }}</h1>
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Torna alla Dashboard
                </a>
            </div>

            <form id="editCarForm" method="POST" action="{{ url_for('admin_edit_car', car_id=car.id) }}">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Immagine Principale</h5>
                        <div class="mb-3 text-center">
                            <input type="hidden" id="main_image_url" name="main_image_url" value="{{ car.image }}" required>
                            
                            <div id="main_image_preview_container" class="mb-3">
                                <img id="main_image_preview_img" src="{{ car.image }}" class="img-thumbnail" style="max-height: 300px; width: auto;">
                            </div>

                            <button type="button" class="btn btn-primary btn-lg search-wiki-btn" data-target="#main_image_url" data-preview="#main_image_preview_img" data-preview-container="#main_image_preview_container">
                                <i class="fas fa-edit me-2"></i> Cambia Immagine Principale
                            </button>
                            <div class="form-text mt-2">Cerca e seleziona una nuova immagine da Wikimedia Commons</div>
                        </div>
                    </div>
                </div>

                <!-- Campi form -->
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Nome*</label>
                                    <input type="text" class="form-control" id="name" name="name" value="{{ car.name }}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="brand" class="form-label">Marca*</label>
                                    <input type="text" class="form-control" id="brand" name="brand" value="{{ car.brand }}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="model" class="form-label">Modello*</label>
                                    <input type="text" class="form-control" id="model" name="model" value="{{ car.model }}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="year" class="form-label">Anno</label>
                                    <input type="number" class="form-control" id="year" name="year" value="{{ car.year }}" min="1900" max="2100">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="engine" class="form-label">Motore*</label>
                                    <input type="text" class="form-control" id="engine" name="engine" value="{{ car.engine }}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="car_type" class="form-label">Tipo/Categoria*</label>
                                    <select class="form-control" id="car_type" name="car_type" required>
                                        <option value="Sportiva" {% if car.car_type == 'Sportiva' %}selected{% endif %}>Sportiva</option>
                                        <option value="Supercar" {% if car.car_type == 'Supercar' %}selected{% endif %}>Supercar</option>
                                        <option value="Hypercar" {% if car.car_type == 'Hypercar' %}selected{% endif %}>Hypercar</option>
                                        <option value="Berlina" {% if car.car_type == 'Berlina' %}selected{% endif %}>Berlina</option>
                                        <option value="Muscle Car" {% if car.car_type == 'Muscle Car' %}selected{% endif %}>Muscle Car</option>
                                        <option value="GT" {% if car.car_type == 'GT' %}selected{% endif %}>GT</option>
                                        <option value="Utilitaria" {% if car.car_type == 'Utilitaria' %}selected{% endif %}>Utilitaria</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="small_description" class="form-label">Breve Descrizione*</label>
                                    <input type="text" class="form-control" id="small_description" name="small_description" maxlength="100" value="{{ car.small_description }}" required>
                                    <small class="text-muted">Max 100 caratteri</small>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">Descrizione Completa*</label>
                                    <textarea class="form-control" id="description" name="description" rows="4" required>{{ car.description }}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Immagini aggiuntive esistenti -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4>Immagini Aggiuntive</h4>
                                <div class="d-flex flex-wrap">
                                    {% for image in additional_images %}
                                    <div class="card m-2 additional-image-card" style="width: 200px;">
                                        <img src="{{ image.image }}" class="card-img-top" alt="Immagine Auto" style="height: 150px; object-fit: cover;">
                                        <div class="card-body text-center">
                                            <p class="card-text small text-truncate">{{ image.image }}</p>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="delete_image" value="{{ image.id }}" id="delete_image_{{ image.id }}">
                                                <label class="form-check-label" for="delete_image_{{ image.id }}">
                                                    Elimina
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}

                                    {% if not additional_images %}
                                    <p class="text-muted">Nessuna immagine aggiuntiva presente.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Aggiungi nuove immagini -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">Aggiungi nuove immagini</label>
                                    <div id="additional_images_container">
                                        <!-- Nuovi campi verranno aggiunti qui -->
                                    </div>
                                    <button type="button" class="btn btn-outline-primary mt-2" id="add_image_field">
                                        <i class="fas fa-plus"></i> Aggiungi Immagine Secondaria
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mt-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Salva Modifiche
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ricerca Wikimedia -->
<div class="modal fade" id="wikiSearchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cerca su Wikimedia Commons</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="wikiSearchInput" placeholder="Es. Ferrari F40">
                    <button class="btn btn-primary" type="button" id="wikiSearchBtn">Cerca</button>
                </div>
                <div id="wikiSearchResults" class="row g-3">
                    <div class="col-12 text-center text-muted">
                        Cerca un'auto per vedere le immagini disponibili.
                    </div>
                </div>
                <div id="wikiSearchLoading" class="text-center d-none mt-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Caricamento...</span>
                    </div>
                </div>
                
                <!-- Paginazione -->
                <div id="wikiSearchPagination" class="d-flex justify-content-between align-items-center mt-3 d-none">
                    <button class="btn btn-outline-secondary" id="wikiPrevBtn" type="button">
                        <i class="fas fa-chevron-left"></i> Precedente
                    </button>
                    <span id="wikiPageIndicator" class="fw-bold">Pagina 1</span>
                    <button class="btn btn-outline-secondary" id="wikiNextBtn" type="button">
                        Successiva <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // --- GESTIONE IMMAGINI AGGIUNTIVE ---
    $('#add_image_field').click(function() {
        const uniqueId = 'additional_img_' + Date.now();
        const previewImgId = 'preview_img_' + uniqueId;
        const previewContId = 'preview_cont_' + uniqueId;
        
        const newField = `
            <div class="card mb-2 border-light bg-light">
                <div class="card-body p-2 d-flex align-items-center justify-content-between">
                    <input type="hidden" id="${uniqueId}" name="additional_image_urls[]">
                    
                    <div class="d-flex align-items-center">
                        <!-- Anteprima piccola -->
                        <div id="${previewContId}" class="me-3 d-none" style="width: 60px; height: 60px; background: #eee; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 4px;">
                            <img id="${previewImgId}" src="" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        
                        <button type="button" class="btn btn-outline-secondary btn-sm search-wiki-btn" 
                                data-target="#${uniqueId}" 
                                data-preview="#${previewImgId}" 
                                data-preview-container="#${previewContId}">
                            <i class="fas fa-search me-1"></i> Cerca Immagine
                        </button>
                    </div>

                    <button type="button" class="btn btn-outline-danger btn-sm remove-image" title="Rimuovi">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>`;
        $('#additional_images_container').append(newField);
        
        // Apri subito la ricerca per il nuovo campo
        setTimeout(() => {
            $(`button[data-target="#${uniqueId}"]`).click();
        }, 100);
    });

    $(document).on('click', '.remove-image', function() {
        $(this).closest('.card').remove();
    });

    // --- LOGICA RICERCA WIKIMEDIA ---
    let currentTargetInput = null;
    let currentPreviewImg = null;
    let currentPreviewContainer = null;
    let currentOffset = 0;
    const limit = 20;

    // Open modal
    $(document).on('click', '.search-wiki-btn', function() {
        currentTargetInput = $($(this).data('target'));
        currentPreviewImg = $($(this).data('preview'));
        currentPreviewContainer = $($(this).data('preview-container'));
        
        // Reset offset
        currentOffset = 0;
        
        // Costruisci la query con Marca e Modello attuali
        const brand = $('#brand').val() || '';
        const model = $('#model').val() || '';
        const carName = (brand + ' ' + model).trim();
        
        // Aggiorna sempre il campo di ricerca se abbiamo dati
        if (carName !== '') {
            $('#wikiSearchInput').val(carName);
        }
        
        $('#wikiSearchModal').modal('show');
        
        // Avvia automaticamente la ricerca se c'è testo
        if ($('#wikiSearchInput').val()) {
            setTimeout(searchWiki, 300);
        }
    });

    // Search function
    function searchWiki() {
        const query = $('#wikiSearchInput').val();
        if (!query) return;

        $('#wikiSearchResults').addClass('d-none');
        $('#wikiSearchLoading').removeClass('d-none');
        $('#wikiSearchPagination').addClass('d-none');

        $.get('/api/search_wikimedia', { q: query, offset: currentOffset })
            .done(function(data) {
                const container = $('#wikiSearchResults');
                container.empty();
                
                if (data.error) {
                    container.html(`<div class="col-12 text-danger">Errore: ${data.error}</div>`);
                } else if (data.length === 0 && currentOffset === 0) {
                    container.html('<div class="col-12 text-center">Nessuna immagine trovata.</div>');
                } else {
                    if (data.length === 0) {
                        container.html('<div class="col-12 text-center">Nessun\'altra immagine trovata.</div>');
                    } else {
                        data.forEach(img => {
                            const html = `
                                <div class="col-6 col-md-4 col-lg-3">
                                    <div class="card h-100 cursor-pointer select-wiki-image shadow-sm" data-url="${img.url}" style="cursor: pointer; transition: transform 0.2s;">
                                        <img src="${img.thumb}" class="card-img-top" style="height: 120px; object-fit: cover;" alt="${img.title}">
                                        <div class="card-body p-2">
                                            <small class="card-text text-truncate d-block" title="${img.title}">${img.title}</small>
                                        </div>
                                    </div>
                                </div>
                            `;
                            container.append(html);
                        });
                        
                        // Hover effect
                        $('.select-wiki-image').hover(
                            function() { $(this).css('transform', 'scale(1.05)'); },
                            function() { $(this).css('transform', 'scale(1.0)'); }
                        );
                    }
                }
                
                $('#wikiSearchLoading').addClass('d-none');
                container.removeClass('d-none');
                
                // Gestione paginazione
                if (data.length > 0 || currentOffset > 0) {
                    $('#wikiSearchPagination').removeClass('d-none');
                    $('#wikiPrevBtn').prop('disabled', currentOffset === 0);
                    // Se abbiamo ricevuto meno risultati del limite, probabilmente siamo alla fine
                    $('#wikiNextBtn').prop('disabled', data.length < limit);
                    const pageNum = Math.floor(currentOffset / limit) + 1;
                    $('#wikiPageIndicator').text('Pagina ' + pageNum);
                }
            })
            .fail(function(jqXHR) {
                $('#wikiSearchLoading').addClass('d-none');
                let errorMsg = 'Errore nella comunicazione con il server.';
                if (jqXHR.status === 404) {
                    errorMsg = 'Errore 404: API non trovata. Riavvia il server.';
                }
                $('#wikiSearchResults').html(`<div class="col-12 text-danger">${errorMsg}</div>`).removeClass('d-none');
            });
    }

    $('#wikiSearchBtn').click(function() {
        currentOffset = 0;
        searchWiki();
    });
    
    $('#wikiPrevBtn').click(function() {
        if (currentOffset >= limit) {
            currentOffset -= limit;
            searchWiki();
        }
    });

    $('#wikiNextBtn').click(function() {
        currentOffset += limit;
        searchWiki();
    });

    $('#wikiSearchInput').keypress(function(e) {
        if(e.which == 13) {
            currentOffset = 0;
            searchWiki();
        }
    });

    // Select image
    $(document).on('click', '.select-wiki-image', function() {
        const url = $(this).data('url');
        
        if (currentTargetInput) {
            currentTargetInput.val(url);
        }
        
        if (currentPreviewImg && currentPreviewContainer) {
            currentPreviewImg.attr('src', url);
            currentPreviewContainer.removeClass('d-none');
            // Se è un'immagine aggiuntiva, rimuovi il d-none inline se presente (per il div flex)
            if(currentPreviewContainer.hasClass('d-none')) {
                 currentPreviewContainer.removeClass('d-none');
            }
            // Forza display block/flex
            currentPreviewContainer.css('display', 'flex');
        }
        
        $('#wikiSearchModal').modal('hide');
    });
});
</script>
{% endblock %}
